name: PR Triage

on:
  pull_request:
    types: [opened, ready_for_review]

permissions:
  pull-requests: write
  issues: write

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Label and acknowledge PR
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const pr = context.payload.pull_request;
            
            // Get changed files
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            
            const labels = ['needs-review'];
            const filePaths = files.data.map(f => f.filename);
            
            // Auto-label based on files changed
            if (filePaths.some(f => f.startsWith('docs/'))) {
              labels.push('documentation');
            }
            if (filePaths.some(f => f.startsWith('src/'))) {
              labels.push('code');
            }
            if (filePaths.some(f => f.includes('test'))) {
              labels.push('tests');
            }
            if (filePaths.some(f => f.endsWith('.md') && !f.startsWith('docs/'))) {
              labels.push('markdown');
            }
            if (filePaths.some(f => f.includes('.github/workflows'))) {
              labels.push('ci-cd');
            }
            
            // Add size label
            const additions = pr.additions || 0;
            const deletions = pr.deletions || 0;
            const totalChanges = additions + deletions;
            
            if (totalChanges < 10) labels.push('size/XS');
            else if (totalChanges < 50) labels.push('size/S');
            else if (totalChanges < 200) labels.push('size/M');
            else if (totalChanges < 500) labels.push('size/L');
            else labels.push('size/XL');
            
            // Add labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: labels
            });
            
            // Check if first-time contributor
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all'
            });
            
            const authorPRs = prs.data.filter(p => p.user.login === pr.user.login);
            const isFirstPR = authorPRs.length === 1;
            
            // Thank contributor
            let message = '';
            
            if (isFirstPR) {
              message = `ðŸŽ‰ **Welcome, @${pr.user.login}!** Thanks for your first contribution to ConferenceHaven!\n\n`;
            } else {
              message = `Thanks for the PR, @${pr.user.login}! ðŸ™Œ\n\n`;
            }
            
            message += '**Next steps:**\n';
            message += '1. âœ… Automated checks will run (CI/CD)\n';
            message += '2. ðŸ‘€ A maintainer will review within 24-48 hours\n';
            message += '3. ðŸ’¬ Address any requested changes\n';
            message += '4. ðŸš€ Once approved, we\'ll merge!\n\n';
            
            // Add context based on PR type
            if (labels.includes('documentation')) {
              message += '**Documentation PR detected.** Please ensure:\n';
              message += '- Links are valid (CI will check)\n';
              message += '- Markdown formatting is consistent\n';
              message += '- Examples are tested and accurate\n';
            }
            
            if (labels.includes('code')) {
              message += '**Code PR detected.** Please ensure:\n';
              message += '- Tests are included (if applicable)\n';
              message += '- Code follows existing style\n';
              message += '- No sensitive data (credentials, tokens)\n';
            }
            
            message += '\n---\n\n';
            message += '**Questions?** Check our [Contributing Guide](https://github.com/fabianwilliams/ConferenceHaven-Community/blob/main/docs/CONTRIBUTING.md)';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: message
            });
            
            // Assign to maintainer
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              assignees: ['fabianwilliams']
            });
